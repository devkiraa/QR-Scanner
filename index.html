<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>QR Code Scanner Web App</title>
</head>
<body>
   <h1>QR Code Scanner</h1>
   <video id="qr-video" width="100%" height="auto"></video>
   <p>Scanned Data: <span id="scanned-data"></span></p>
   <button id="capture-button">Capture</button>
   <canvas id="captured-image" style="display: none;"></canvas>

   <!-- Include the jsQR library just before the closing </body> tag -->
   <script src="https://cdn.jsdelivr.net/npm/jsqr@1.0.0/dist/jsQR.js"></script>

   <!-- Your custom JavaScript code -->
   <script>
       const video = document.getElementById('qr-video');
       const scannedDataElement = document.getElementById('scanned-data');
       const captureButton = document.getElementById('capture-button');
       const capturedImageCanvas = document.getElementById('captured-image');
       const capturedImageContext = capturedImageCanvas.getContext('2d');

       // Use getUserMedia to access the webcam
       navigator.mediaDevices
           .getUserMedia({ video: { facingMode: 'environment' } }) // Use the device's rear camera
           .then(function (stream) {
               video.srcObject = stream;
               video.play();
               scanQRCode();
           })
           .catch(function (error) {
               console.error('Error accessing the webcam:', error);
           });

       captureButton.addEventListener('click', captureImage);

       function scanQRCode() {
           const canvas = document.createElement('canvas');
           const context = canvas.getContext('2d');

           // Continuously scan for QR codes
           function checkForQRCode() {
               if (video.readyState === video.HAVE_ENOUGH_DATA) {
                   canvas.width = video.videoWidth;
                   canvas.height = video.videoHeight;
                   context.drawImage(video, 0, 0, canvas.width, canvas.height);

                   const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                   const code = jsQR(imageData.data, imageData.width, imageData.height);

                   if (code) {
                       const scannedData = code.data;
                       scannedDataElement.textContent = scannedData;
                       
                       // Send scanned data to Google Sheets
                       sendQRDataToGoogleSheets(scannedData);
                   }
               }
               requestAnimationFrame(checkForQRCode);
           }

           checkForQRCode();
       }

       function captureImage() {
           capturedImageCanvas.width = video.videoWidth;
           capturedImageCanvas.height = video.videoHeight;
           capturedImageContext.drawImage(video, 0, 0, capturedImageCanvas.width, capturedImageCanvas.height);

           // Convert the captured image to a data URL
           const imageDataURL = capturedImageCanvas.toDataURL('image/jpeg');

           // Decode QR code from the captured image
           const image = new Image();
           image.src = imageDataURL;

           image.onload = function () {
               const qrCode = jsQR(
                   capturedImageContext.getImageData(0, 0, capturedImageCanvas.width, capturedImageCanvas.height).data,
                   capturedImageCanvas.width,
                   capturedImageCanvas.height
               );

               if (qrCode) {
                   const scannedData = qrCode.data;
                   scannedDataElement.textContent = scannedData;
                   
                   // Send scanned data to Google Sheets
                   sendQRDataToGoogleSheets(scannedData);
               } else {
                   alert('No QR code found in the captured image.');
               }
           };
       }

       // Function to send scanned data to Google Sheets
       function sendQRDataToGoogleSheets(data) {
           fetch('https://script.google.com/macros/s/AKfycbw0DyxfWHJTZe2Fsjencz1TqHz7Vg6gJxOi0MXCiRaHW1P2ATL1NDIsmd14ZWXQLF2-ow/exec', { // Replace with your web app URL
               method: 'POST',
               headers: {
                   'Content-Type': 'application/json',
               },
               body: JSON.stringify({ qrData: data }),
           })
           .then(response => response.text())
           .then(result => {
               console.log(result);
           })
           .catch(error => {
               console.error('Error sending QR data:', error);
           });
       }
   </script>
</body>
</html>
