<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>QR Code Scanner Web App</title>
</head>
<body>
   <h1>QR Code Scanner</h1>
   <video id="qr-video" width="100%" height="auto"></video>
   <p>Scanned Data: <span id="scanned-data"></span></p>
   <form id="qr-form" method="POST" action="/scan" enctype="multipart/form-data">
       <input type="file" id="qr-image" accept="image/*" capture="environment">
       <button id="capture-button">Capture</button>
       <button id="send-button" style="display: none;">Send to Sheets</button>
   </form>
   <p id="send-status"></p>
   <canvas id="captured-image" style="display: none;"></canvas>

   <!-- Include the jsQR library just before the closing </body> tag -->
   <script src="https://cdn.jsdelivr.net/npm/jsqr@1.0.0/dist/jsQR.js"></script>

   <!-- Your custom JavaScript code -->
   <script>
       const video = document.getElementById('qr-video');
       const scannedDataElement = document.getElementById('scanned-data');
       const captureButton = document.getElementById('capture-button');
       const sendButton = document.getElementById('send-button');
       const sendStatus = document.getElementById('send-status');
       const capturedImageCanvas = document.getElementById('captured-image');
       const capturedImageContext = capturedImageCanvas.getContext('2d');
       const qrForm = document.getElementById('qr-form');
       const qrImageInput = document.getElementById('qr-image');

       let isCaptured = false;

       // Use getUserMedia to access the webcam
       navigator.mediaDevices
           .getUserMedia({ video: { facingMode: 'environment' } }) // Use the device's rear camera
           .then(function (stream) {
               video.srcObject = stream;
               video.play();
           })
           .catch(function (error) {
               console.error('Error accessing the webcam:', error);
           });

       captureButton.addEventListener('click', captureImage);
       sendButton.addEventListener('click', sendImageToSheets);

       function captureImage() {
           if (!isCaptured) {
               isCaptured = true;
               captureButton.textContent = 'Recapture'; // Change button text
               sendButton.style.display = 'none'; // Hide the "Send to Sheets" button
               sendStatus.textContent = ''; // Clear send status

               capturedImageCanvas.width = video.videoWidth;
               capturedImageCanvas.height = video.videoHeight;
               capturedImageContext.drawImage(video, 0, 0, capturedImageCanvas.width, capturedImageCanvas.height);

               // Convert the captured image to grayscale (improves QR code detection)
               capturedImageContext.filter = 'grayscale(100%)';
               capturedImageContext.drawImage(video, 0, 0, capturedImageCanvas.width, capturedImageCanvas.height);

               // Convert the captured image to a data URL
               const imageDataURL = capturedImageCanvas.toDataURL('image/jpeg');

               // Display the captured image
               capturedImageCanvas.style.display = 'block';
               qrImageInput.style.display = 'none';

               // Decode QR code from the captured image
               const image = new Image();
               image.src = imageDataURL;

               image.onload = function () {
                   const qrCode = jsQR(
                       capturedImageContext.getImageData(0, 0, capturedImageCanvas.width, capturedImageCanvas.height).data,
                       capturedImageCanvas.width,
                       capturedImageCanvas.height
                   );

                   if (qrCode) {
                       const scannedData = qrCode.data;
                       scannedDataElement.textContent = scannedData;
                       sendButton.style.display = 'block'; // Show the "Send to Sheets" button
                   } else {
                       alert('No QR code found in the captured image.');
                   }
               };
           } else {
               // If already captured, allow recapturing
               isCaptured = false;
               captureButton.textContent = 'Capture'; // Reset button text
               sendButton.style.display = 'none'; // Hide the "Send to Sheets" button
               scannedDataElement.textContent = ''; // Clear scanned data
               sendStatus.textContent = ''; // Clear send status

               // Hide the captured image and show the QR image input
               capturedImageCanvas.style.display = 'none';
               qrImageInput.style.display = 'block';
           }
       }

       function sendImageToSheets() {
           if (isCaptured) {
               const imageDataURL = capturedImageCanvas.toDataURL('image/jpeg');

               // Send the image data to the Python server for further processing and sending to Sheets
               fetch('/scan', {
                   method: 'POST',
                   headers: {
                       'Content-Type': 'application/json',
                   },
                   body: JSON.stringify({ qrImageData: imageDataURL }),
               })
               .then(response => response.json())
               .then(result => {
                   console.log(result);
                   sendStatus.textContent = 'Data sent to Sheets successfully.';
               })
               .catch(error => {
                   console.error('Error sending image data to Python server:', error);
                   sendStatus.textContent = 'Error sending data to Sheets.';
               });
           } else {
               alert('Please capture an image first.');
           }
       }
   </script>
</body>
</html>
